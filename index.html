<html>
    <head>
        <title>TRV Replays</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script>  
            var instace;
            var tournamentId;

            $(document).ready(function () {
                $('#tournament-id-button').bind('click', loadTournament);

                // Override the XMLHttpRequest Open prototype so we can add an event listener.
                // The Unity Game will load /current/ tournament once the game is loaded.
                // To prevent the current running tournament displaying, we need to catch when the request to current happens
                // and afterwards send the message to load our tournament.
                var origOpen = XMLHttpRequest.prototype.open;
                XMLHttpRequest.prototype.open = function() {
                    if (arguments[1] === 'https://federation.theredvillage.com/battles/current') {
                        if (tournamentId && tournamentId > 0) {
                            this.addEventListener('load', function() {
                                loadTournament();
                            });
                        }
                    } 

                    origOpen.apply(this, arguments);
                };

                // Add event listener for window load, once window is loaded we can create a game instance
                if (document.readyState === 'complete') {
                    loadGame();
                } else {
                    $(window).on('load', function () {
                        // Creates an instance of the unity game
                        loadGame();
                    });
                }
            });

            // Set a tournament for the game instance to play.
            function loadTournament () {
                if (!tournamentId || tournamentId < 1) {
                    tournamentId = $('#tournament-id').val();
                }

                instance.SendMessage('Game', 'SetMatch', Number(tournamentId));
            }

            // Pull Unity build and load an instance of the game.
            async function loadGame () {
                let buildUrlSuffix = 'https://redvillage-game-assets-prod.s3.ap-southeast-1.amazonaws.com/Build/Game'
                let config = {
                    dataUrl: `${buildUrlSuffix}.data.br`,
                    frameworkUrl: `${buildUrlSuffix}.framework.js.br`,
                    codeUrl: `${buildUrlSuffix}.wasm.br`,
                    streamingAssetsUrl: '/TemplateData/',
                    productName: 'The Red Village',
                    useWasm: true
                }

                let canvas = $('#unity-canvas')[0];
                instance = await window.createUnityInstance(canvas, config, progression => {
                    
                });

                // Hide loading once game is loaded.
                $('.game-loading').css('display', 'none');

                // Check query string for a tournament id to replay.
                let tournamentIdQuery = getTournamentFromQueryString();

                if (isNaN(tournamentIdQuery) === false) {
                    tournamentId = Number(tournamentIdQuery);
                }
            }

            // Pull tournament id from query string if there is one.
            function getTournamentFromQueryString() {
                let params = new Proxy(new URLSearchParams(window.location.search), {
                    get: (searchParams, prop) => searchParams.get(prop),
                });

                let tournamentQueryValue = params.id;

                return tournamentQueryValue;
            }
        </script>

        <style>
            body {
                background-color: black;
                margin: 0;
            }

            .game-canvas {
                width: 100%;
                height: 80%;
            }

            .game-loading {
                position: absolute;
                height: calc(100vh);
                width: calc(100vw);
                top: 0;
            }

            .game-loading img {
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div>
            <input id="tournament-id" type="number" />
            <button id="tournament-id-button">Replay</button>
        </div>
        <div>
            <div class="game-context">
                <div class="game-container">
                    <canvas
                        id="unity-canvas"
                        class="game-canvas"
                    ></canvas>
                </div>
                <div class="game-loading">
                    <img src="https://theredvillage.com/img/unity_loading.png"  />
                </div>
            </div>
        </div>

        <script src="https://redvillage-game-assets-prod.s3.ap-southeast-1.amazonaws.com/Build/Game.loader.js" async=""></script>
        <script src="https://redvillage-game-assets-prod.s3.ap-southeast-1.amazonaws.com/Build/Game.framework.js.br"></script>
    </body>
</html>
